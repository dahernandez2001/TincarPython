{% extends "layout.html" %}
{% block content %}

<!-- Header (logo + nav) -->
<header class="py-3">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="TinCar" style="height:44px; margin-right:14px;">
      <span class="h4 text-warning fw-bold mb-0">TinCar</span>
    </div>
    <nav>
      <a href="#" class="text-light me-3">Inicio</a>
      <a href="#" class="text-light me-3">Reservar</a>
      <a href="#" class="text-light">Configuraci贸n</a>
    </nav>
  </div>
</header>

<main class="container py-4 text-light">
  <div class="landlord-header d-flex justify-content-between align-items-start mb-4">
    <div>
      <h2 class="fw-bold">Modo arrendador</h2>
      <p class="text-secondary">Bienvenido, {{ nombre }}</p>
    </div>
  </div>

  <div class="landlord-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Tus parqueaderos</h5>
  <button id="openAddParking" class="btn btn-orange" onclick="openModal()">Agregar parqueadero</button>
    </div>

    <div class="inner-border p-3" style="border-radius:8px;">
      <div class="table-responsive" style="max-height:220px; overflow:auto;">
          <table class="table table-dark parkings-table mb-0 align-middle">
          <thead>
            <tr>
              <th>Parqueadero</th>
              <th>Estado</th>
              <th>Tarifa</th>
              <th>Tiempo</th>
              <th class="text-end">Activo</th>
            </tr>
          </thead>
          <tbody>
            {% for p in parkings %}
            <tr data-parking-id="{{ p.id }}" data-active="{{ 1 if p.active else 0 }}" data-occupied="{{ p.occupied_since or '' }}">
              <td class="fw-semibold parking-name" data-parking-id="{{ p.id }}">{{ p.name }}</td>
              <td class="text-muted small parking-status">{{ p.status or ( 'Libre' if p.active else 'Ocupado' ) }}</td>
              <td class="text-warning">$3.000 / 10min</td>
              <td class="text-muted small parking-time"><span id="time-{{ p.id }}">{% if p.occupied_since %}00:00:00{% else %}00:00:00{% endif %}</span></td>
              <td class="text-end">
                <div class="form-check form-switch d-inline-block">
                  <input class="form-check-input parking-toggle" type="checkbox" role="switch" data-parking-id="{{ p.id }}" id="switch{{ loop.index }}" {% if p.active %}checked{% endif %}>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal: Agregar parqueadero -->
    <div id="addParkingModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <button id="closeModal" class="modal-close"></button>
        <div class="modal-header text-center">
          <span class="badge btn-orange">Agregar parqueadero</span>
        </div>
        <form id="addParkingForm">
          <div class="modal-body">
            <div class="row g-2 mb-3">
              <div class="col-4"><input name="name" class="form-control" placeholder="Nombre Garaje"></div>
              <div class="col-4"><input name="phone" class="form-control" placeholder="Tel茅fono"></div>
              <div class="col-4"><input name="email" class="form-control" placeholder="Correo electr贸nico"></div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input name="address" class="form-control" placeholder="Direcci贸n"></div>
              <div class="col-4">
                <select id="add-department" name="department" class="form-control">
                  <option value="">Departamento</option>
                </select>
              </div>
              <div class="col-4">
                <select id="add-city" name="city" class="form-control">
                  <option value="">Ciudad / Municipio</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mb-3">
              <!-- Campos para coordenadas (latitud / longitud) -->
              <div class="col-6"><input name="latitude" class="form-control" placeholder="Latitud (ej: 4.60971)"></div>
              <div class="col-6"><input name="longitude" class="form-control" placeholder="Longitud (ej: -74.08175)"></div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input name="housing_type" class="form-control" placeholder="Tipo de vivienda"></div>
              <div class="col-4"><input name="size" class="form-control" placeholder="Medidas"></div>
              <div class="col-4"><input name="features" class="form-control" placeholder="Caracter铆sticas"></div>
            </div>

            <div class="d-flex justify-content-center my-3">
              <div class="upload-placeholder text-center">
                <div style="font-size:64px; opacity:0.2;"></div>
                <div class="text-muted">(foto)</div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between p-3" style="background:#FFEFE0; border-bottom-left-radius:8px; border-bottom-right-radius:8px;">
            <button type="button" id="cancelBtn" class="btn btn-outline-light">Cancelar</button>
            <button type="submit" class="btn btn-orange">Agregar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- removed Ver todos button per UX request -->
    <!-- Modal: Ver / Editar parqueadero (top-level) -->
    <div id="viewParkingModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <button id="closeViewModal" class="modal-close"></button>
        <div class="modal-header text-center">
          <span class="badge btn-orange">Detalle del parqueadero</span>
        </div>
        <form id="viewParkingForm">
          <div class="modal-body">
            <input type="hidden" name="id" id="vp-id">
            <div class="row g-2 mb-3">
              <div class="col-4"><input id="vp-name" name="name" class="form-control" placeholder="Nombre Garaje"></div>
              <div class="col-4"><input id="vp-phone" name="phone" class="form-control" placeholder="Tel茅fono"></div>
              <div class="col-4"><input id="vp-email" name="email" class="form-control" placeholder="Correo electr贸nico"></div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input id="vp-address" name="address" class="form-control" placeholder="Direcci贸n"></div>
              <div class="col-4">
                <select id="vp-department" name="department" class="form-control">
                  <option value="">Departamento</option>
                </select>
              </div>
              <div class="col-4">
                <select id="vp-city" name="city" class="form-control">
                  <option value="">Ciudad / Municipio</option>
                </select>
              </div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input id="vp-housing_type" name="housing_type" class="form-control" placeholder="Tipo de vivienda"></div>
              <div class="col-4"><input id="vp-size" name="size" class="form-control" placeholder="Medidas"></div>
              <div class="col-4"><input id="vp-features" name="features" class="form-control" placeholder="Caracter铆sticas"></div>
            </div>

            <div class="row g-2 mb-3">
              <!-- Campos de coordenadas para edici贸n -->
              <div class="col-6"><input id="vp-latitude" name="latitude" class="form-control" placeholder="Latitud"></div>
              <div class="col-6"><input id="vp-longitude" name="longitude" class="form-control" placeholder="Longitud"></div>
            </div>

            <div class="d-flex justify-content-center my-3">
              <div id="vp-image-preview" class="upload-placeholder text-center">
                <div style="font-size:64px; opacity:0.2;"></div>
                <div class="text-muted">(foto)</div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between p-3" style="background:#FFEFE0; border-bottom-left-radius:8px; border-bottom-right-radius:8px;">
            <div>
              <button type="button" id="deleteParkingBtn" class="btn btn-outline-light">Eliminar</button>
            </div>
            <div>
              <button type="button" id="cancelViewBtn" class="btn btn-outline-light">Cancelar</button>
              <button type="submit" class="btn btn-orange">Guardar cambios</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notificaciones en el icono del cono -->
  <div id="notificationIcon" class="position-fixed" style="top: 20px; right: 20px; cursor: pointer;">
    <img src="{{ url_for('static', filename='img/cono.png') }}" alt="Notificaciones" style="width: 40px; height: 40px;">
    <span id="notificationCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
  </div>

  <!-- Modal de Notificaciones -->
  <div id="notificationsModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" style="max-width: 500px;">
      <button class="modal-close" onclick="closeNotificationsModal()"></button>
      <div class="modal-header">
        <h5 class="mb-0">Notificaciones</h5>
      </div>
      <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
        <div id="notificationsList">
          <!-- Las notificaciones se cargar谩n aqu铆 din谩micamente -->
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-light">Cerrar sesi贸n</a>
  </div>
</main>

{% endblock %}

{% block scripts %}
<script>
// Funciones para el manejo de notificaciones
let notifications = [];

function updateNotificationCount() {
    const unreadCount = notifications.filter(n => n.status === 'unread').length;
    const countBadge = document.getElementById('notificationCount');
    if (countBadge) {
        countBadge.textContent = unreadCount;
        countBadge.style.display = unreadCount > 0 ? 'block' : 'none';
    }
}

function loadNotifications() {
    fetch('/api/notifications')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                notifications = data.notifications;
                updateNotificationCount();
                const notificationsList = document.getElementById('notificationsList');
                if (notificationsList) {
                    notificationsList.innerHTML = notifications.map(notification => {
                        let actionsHtml = '';
                        if (notification.type === 'driver_arrived') {
                            actionsHtml = `
                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-sm btn-success" onclick="finishReservation(${notification.reservation_id})">Finalizar reserva</button>
                                    <button class="btn btn-sm btn-primary" onclick="contactDriver(${JSON.parse(notification.extra_data || '{}').driver_id})">Contactar</button>
                                </div>
                            `;
                        } else if (notification.type === 'new_reservation') {
                            actionsHtml = `
                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-sm btn-primary" onclick="contactDriver(${JSON.parse(notification.extra_data || '{}').driver_id})">Contactar</button>
                                    <button class="btn btn-sm btn-danger" onclick="cancelReservation(${notification.reservation_id})">Cancelar</button>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="notification-item p-3 mb-2 ${notification.status === 'unread' ? 'bg-dark' : ''}" style="border-radius: 8px;">
                                <p class="mb-1">${notification.message}</p>
                                <small class="text-muted">${new Date(notification.created_at).toLocaleString()}</small>
                                ${actionsHtml}
                            </div>
                        `;
                    }).join('');
                }
            }
        })
        .catch(error => console.error('Error cargando notificaciones:', error));
}

// Funciones para el modal de notificaciones
function openNotificationsModal() {
    const modal = document.getElementById('notificationsModal');
    if (modal) {
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        loadNotifications();
        // Marcar todas las notificaciones como le铆das
        fetch('/api/notifications/mark-read', { method: 'POST' })
            .then(() => loadNotifications())
            .catch(error => console.error('Error marcando notificaciones como le铆das:', error));
    }
}

function closeNotificationsModal() {
    const modal = document.getElementById('notificationsModal');
    if (modal) {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
    }
}

function finishReservation(reservationId) {
    if (confirm('驴Est谩s seguro de que deseas finalizar la reserva?')) {
        fetch(`/api/reservations/${reservationId}/finish`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNotifications();
            } else {
                alert('Error al finalizar la reserva: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function contactDriver(driverId) {
    // Implementar la l贸gica de contacto con el conductor
    alert('Funci贸n de contacto en desarrollo');
}

function cancelReservation(reservationId) {
    if (confirm('驴Est谩s seguro de que deseas cancelar la reserva?')) {
        fetch(`/api/reservations/${reservationId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNotifications();
            } else {
                alert('Error al cancelar la reserva: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// Event listeners para notificaciones
document.addEventListener('DOMContentLoaded', () => {
    // Cargar notificaciones inicialmente
    loadNotifications();
    
    // Configurar polling para notificaciones (cada 10 segundos)
    setInterval(loadNotifications, 10000);
    
    // Event listener para el icono de notificaciones
    const notificationIcon = document.getElementById('notificationIcon');
    if (notificationIcon) {
        notificationIcon.addEventListener('click', openNotificationsModal);
    }
});
</script>

<script>
// Timers para parqueaderos ocupados y refresco peri贸dico
function startParkingTimers(){
  const rows = document.querySelectorAll('tr[data-parking-id]');
  rows.forEach(row=>{
    const pid = row.getAttribute('data-parking-id');
    const active = row.getAttribute('data-active');
    const occupied = row.getAttribute('data-occupied');
    const timeSpan = document.getElementById('time-'+pid);
    // clear existing interval stored on element
    if(row._timer) { clearInterval(row._timer); row._timer = null; }
    if(active === '0' && occupied){
      // calcular desde occupied timestamp
      let start = Date.parse(occupied);
      if(isNaN(start)) start = Date.now();
      function update(){
        const diff = Date.now() - start;
        const hrs = Math.floor(diff/3600000);
        const mins = Math.floor((diff%3600000)/60000);
        const secs = Math.floor((diff%60000)/1000);
        const text = String(hrs).padStart(2,'0')+':'+String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
        if(timeSpan) timeSpan.textContent = text;
      }
      update();
      row._timer = setInterval(update, 1000);
      // update status text
      const statusEl = row.querySelector('.parking-status');
      if(statusEl) statusEl.textContent = 'Ocupado';
    } else {
      // ensure shows Libre and zeroed time
      const statusEl = row.querySelector('.parking-status');
      if(statusEl) statusEl.textContent = 'Libre';
      if(timeSpan) timeSpan.textContent = '00:00:00';
    }
  });
}

// Polling para actualizar lista cada 8s (permite ver cambios tras reservas)
function pollOwnerParkings(){
  fetch('/api/owner/parkings')
    .then(r=>r.json())
    .then(data=>{
      if(!data.success) return;
      const parkings = data.parkings || [];
      parkings.forEach(p=>{
        const row = document.querySelector(`tr[data-parking-id="${p.id}"]`);
        if(!row) return;
        row.setAttribute('data-active', p.active? '1':'0');
        row.setAttribute('data-occupied', p.occupied_since || '');
      });
      startParkingTimers();
    }).catch(()=>{});
}

document.addEventListener('DOMContentLoaded', ()=>{
  // iniciar timers en la carga
  startParkingTimers();
  // comenzar polling
  setInterval(pollOwnerParkings, 8000);
});

// Modal open/close
const openBtn = document.getElementById('openAddParking');
const modal = document.getElementById('addParkingModal');
const closeBtn = document.getElementById('closeModal');
const cancelBtn = document.getElementById('cancelBtn');
const form = document.getElementById('addParkingForm');

// debug badge (visible when modal opens)
let debugBadge = document.getElementById('modalDebug');
if(!debugBadge){
  debugBadge = document.createElement('div');
  debugBadge.id = 'modalDebug';
  debugBadge.style.position = 'fixed';
  debugBadge.style.right = '12px';
  debugBadge.style.bottom = '12px';
  debugBadge.style.background = '#FFB300';
  debugBadge.style.color = '#111';
  debugBadge.style.padding = '6px 10px';
  debugBadge.style.borderRadius = '6px';
  debugBadge.style.display = 'none';
  debugBadge.style.zIndex = 9999;
  document.body.appendChild(debugBadge);
}

function openModal(){
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  // show debug badge briefly
  debugBadge.textContent = 'modal abierto';
  debugBadge.style.display = 'block';
  setTimeout(()=> debugBadge.style.display = 'none', 2000);
}
function closeModal(){
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
}
openBtn && openBtn.addEventListener('click', openModal);
closeBtn && closeBtn.addEventListener('click', closeModal);
cancelBtn && cancelBtn.addEventListener('click', closeModal);

// Submit via fetch (with inline validation and insertion without reload)
form && form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const submitBtn = form.querySelector('button[type="submit"]');
  const data = new FormData(form);
  // Basic client-side validation
  if(!data.get('name') || !data.get('name').trim()){
    alert('Por favor ingresa el nombre del parqueadero.');
    return;
  }
  // Validar que departamento y ciudad est茅n seleccionados
  if(!data.get('department') || !data.get('department').trim()){
    alert('Por favor selecciona un departamento.');
    return;
  }
  if(!data.get('city') || !data.get('city').trim()){
    alert('Por favor selecciona una ciudad.');
    return;
  }
  try{
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';
    const res = await fetch('/parkings/create', { method: 'POST', body: data });
    const json = await res.json();
    if(res.ok && json.success){
      const parking = json.parking;
      insertParkingRow(parking);
      closeModal();
      form.reset();
      if(json.geocode_failed){
        alert(json.message || 'La geocodificaci贸n no encontr贸 coordenadas; por favor edita el parqueadero y agrega latitud/longitud manualmente.');
      }
    } else {
      alert('Error al crear parqueadero: '+(json.error||'error'));
    }
  } catch(err){
    alert('Error de red: '+err.message);
  } finally{
    submitBtn.disabled = false;
    submitBtn.textContent = 'Agregar';
  }
});

function insertParkingRow(p){
  try{
    const tbody = document.querySelector('.parkings-table tbody');
    if(!tbody) return;
    const tr = document.createElement('tr');
    tr.setAttribute('data-parking-id', p.id);
    tr.innerHTML = `
      <td class="fw-semibold parking-name" data-parking-id="${p.id}">${escapeHtml(p.name || '')}</td>
      <td class="text-muted small">${p.status || 'Libre'}</td>
      <td class="text-warning">$3.000 / 10min</td>
      <td class="text-muted small"><span id="time-${p.id}">00:00:00</span></td>
      <td class="text-end">
        <div class="form-check form-switch d-inline-block">
          <input class="form-check-input parking-toggle" type="checkbox" role="switch" data-parking-id="${p.id}" id="switch-new-${p.id}" ${p.active? 'checked':''}>
        </div>
      </td>
    `;
    // Prepend the new row so newest appear on top
    tbody.prepend(tr);
  }catch(err){
    console.error('insertParkingRow error', err);
  }
}

function escapeHtml(unsafe){
  return unsafe
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/\"/g, "&quot;")
       .replace(/'/g, "&#039;");
}

</script>

<script>
// View / Edit modal logic
const viewModal = document.getElementById('viewParkingModal');
const closeView = document.getElementById('closeViewModal');
const cancelViewBtn = document.getElementById('cancelViewBtn');
const viewForm = document.getElementById('viewParkingForm');
const deleteBtn = document.getElementById('deleteParkingBtn');

function openViewModal(){
  viewModal.classList.add('open');
  viewModal.setAttribute('aria-hidden','false');
}
function closeViewModal(){
  viewModal.classList.remove('open');
  viewModal.setAttribute('aria-hidden','true');
}
closeView && closeView.addEventListener('click', closeViewModal);
cancelViewBtn && cancelViewBtn.addEventListener('click', closeViewModal);

// When clicking on a parking name, fetch details and open modal
document.addEventListener('click', async (e)=>{
  // Ensure we handle clicks on text nodes as well
  let node = e.target;
  if(node && node.nodeType === 3) node = node.parentElement;
  const el = node && node.closest ? node.closest('.parking-name') : null;
  if(!el) return;
  const pid = el.getAttribute('data-parking-id') || el.dataset.parkingId;
  try{
    // debug visibility
    console.log('parking-name clicked, id=', pid, 'el=', el);
    if(debugBadge){ debugBadge.textContent = `click ${pid}`; debugBadge.style.display='block'; setTimeout(()=> debugBadge.style.display='none',900); }
    if(!viewModal){ console.error('viewModal element not found'); }
    const res = await fetch(`/parkings/${pid}`);
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'error');
    const p = j.parking;
    // populate form
    document.getElementById('vp-id').value = p.id;
    document.getElementById('vp-name').value = p.name || '';
    document.getElementById('vp-phone').value = p.phone || '';
    document.getElementById('vp-email').value = p.email || '';
    document.getElementById('vp-address').value = p.address || '';
    document.getElementById('vp-department').value = p.department || '';
    document.getElementById('vp-city').value = p.city || '';
    document.getElementById('vp-housing_type').value = p.housing_type || '';
    document.getElementById('vp-size').value = p.size || '';
    document.getElementById('vp-features').value = p.features || '';
    // image preview
    const imgPreview = document.getElementById('vp-image-preview');
    if(p.image_path){
      imgPreview.innerHTML = `<img src="${p.image_path}" alt="img" style="max-width:160px; max-height:120px; border-radius:6px;">`;
    } else {
      imgPreview.innerHTML = `<div style="font-size:64px; opacity:0.2;"></div><div class="text-muted">(foto)</div>`;
    }
    openViewModal();
  }catch(err){
    alert('Error cargando detalle: '+err.message);
  }
});

// Submit update
viewForm && viewForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const pid = document.getElementById('vp-id').value;
  const data = new FormData(viewForm);
  try{
    const res = await fetch(`/parkings/${pid}/update`, { method: 'POST', body: data });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'error');
    const p = j.parking;
    // update row in table
    const row = document.querySelector(`tr[data-parking-id="${p.id}"]`);
    if(row){
      const nameTd = row.querySelector('.parking-name');
      if(nameTd) nameTd.textContent = p.name || '';
    }
    closeViewModal();
    if(j.geocode_failed){
      alert(j.message || 'La geocodificaci贸n no encontr贸 coordenadas; por favor agrega latitud/longitud manualmente.');
    }
  }catch(err){
    alert('Error actualizando: '+err.message);
  }
});

// Delete
deleteBtn && deleteBtn.addEventListener('click', async ()=>{
  if(!confirm('驴Eliminar este parqueadero? Esta acci贸n no se puede deshacer.')) return;
  const pid = document.getElementById('vp-id').value;
  try{
  const res = await fetch(`/api/parkings/${pid}/delete`, { method: 'POST' });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'error');
    // remove row
    const row = document.querySelector(`tr[data-parking-id="${pid}"]`);
    if(row && row.parentNode) row.parentNode.removeChild(row);
    closeViewModal();
  }catch(err){
    alert('Error eliminando: '+err.message);
  }
});
</script>

<script>
// Cargar lista de departamentos/ciudades y poblar selects del modal Agregar/Editar
document.addEventListener('DOMContentLoaded', ()=>{
  const deptSelects = [document.getElementById('add-department'), document.getElementById('vp-department')];
  const citySelects = [document.getElementById('add-city'), document.getElementById('vp-city')];

  fetch('/static/data/colombia_locations.json')
    .then(r => r.json())
    .then(data => {
      const departments = Object.keys(data).sort();
      deptSelects.forEach(sel => {
        if(!sel) return;
        // limpiar excepto la opci贸n por defecto
        sel.innerHTML = '<option value="">Departamento</option>';
        departments.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sel.appendChild(opt);
        });
        // si existe un valor prellenado (ej. en edici贸n), intentar seleccionarlo
        if(sel.dataset && sel.dataset.selected){
          sel.value = sel.dataset.selected;
        }
        sel.addEventListener('change', (e)=>{
          const dep = e.target.value;
          const cities = data[dep] || [];
          // encontrar el city select correspondiente (match by id prefix: add- vs vp-)
          const id = e.target.id.startsWith('add-') ? 'add-city' : 'vp-city';
          const citySel = document.getElementById(id);
          if(!citySel) return;
          citySel.innerHTML = '<option value="">Ciudad / Municipio</option>';
          cities.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; citySel.appendChild(o); });
        });
      });

      // Cuando se abre el view modal, si el departamento ya est谩 en el registro, poblar ciudades
      const openView = document.querySelectorAll('.parking-name');
    })
    .catch(err=>{ console.warn('No se pudo cargar lista de departamentos/ciudades:', err); });

  // Cuando se abre el view modal (click en nombre), se llenan selects si es necesario (el flujo existente
  // asigna los valores en los inputs; aqu铆 nos aseguramos de que las opciones existan y se seleccionen)
  document.addEventListener('click', async (e)=>{
    let node = e.target;
    if(node && node.nodeType === 3) node = node.parentElement;
    const el = node && node.closest ? node.closest('.parking-name') : null;
    if(!el) return;
    const pid = el.getAttribute('data-parking-id') || el.dataset.parkingId;
    try{
      const res = await fetch(`/parkings/${pid}`);
      const j = await res.json();
      if(!res.ok) throw new Error(j.error||'error');
      const p = j.parking;
      // Asegurar selects poblados
      const depSel = document.getElementById('vp-department');
      const citySel = document.getElementById('vp-city');
      if(depSel){
        depSel.value = p.department || '';
        // disparar evento change para poblar ciudades
        const ev = new Event('change');
        depSel.dispatchEvent(ev);
        // esperar un tick y seleccionar ciudad si existe
        setTimeout(()=>{ if(citySel){ citySel.value = p.city || ''; } }, 50);
      }
    }catch(err){ /* no bloquear la UI */ }
  });
});
</script>

<script>
// Toggle active handler: send POST JSON to /parkings/<id>/active
document.addEventListener('change', async (e)=>{
  const t = e.target;
  if(t && t.classList && t.classList.contains('parking-toggle')){
    const pid = t.dataset.parkingId;
    const active = t.checked;
    try{
      const res = await fetch(`/parkings/${pid}/active`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({active})});
      const j = await res.json();
      if(!res.ok) throw new Error(j.error||'error');
      // optionally show little feedback
      debugBadge.textContent = `parking ${pid} active=${j.active}`;
      debugBadge.style.display = 'block';
      setTimeout(()=> debugBadge.style.display='none', 1200);
    } catch(err){
      alert('Error actualizando active: '+err.message);
      // revert switch
      t.checked = !active;
    }
  }
});
</script>
{% endblock %}
