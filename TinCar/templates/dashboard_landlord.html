{% extends "layout.html" %}
{% block content %}

<!-- Header (logo + nav) -->
<header class="py-3">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="TinCar" style="height:44px; margin-right:14px;">
      <span class="h4 text-warning fw-bold mb-0">TinCar</span>
    </div>
    <nav>
      <a href="#" class="text-light me-3">Inicio</a>
      <a href="#" class="text-light me-3">Reservar</a>
      <a href="#" class="text-light">Configuraci贸n</a>
    </nav>
  </div>
</header>

<main class="container py-4 text-light">
  <div class="landlord-header d-flex justify-content-between align-items-start mb-4">
    <div>
      <h2 class="fw-bold">Modo arrendador</h2>
      <p class="text-secondary">Bienvenido, {{ nombre }}</p>
    </div>
  </div>

  <div class="landlord-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Tus parqueaderos</h5>
  <button id="openAddParking" class="btn btn-orange" onclick="openModal()">Agregar parqueadero</button>
    </div>

    <div class="inner-border p-3" style="border-radius:8px;">
      <div class="table-responsive" style="max-height:220px; overflow:auto;">
          <table class="table table-dark parkings-table mb-0 align-middle">
          <thead>
            <tr>
              <th>Parqueadero</th>
              <th>Estado</th>
              <th>Tarifa</th>
              <th>Tiempo</th>
              <th class="text-end">Activo</th>
            </tr>
          </thead>
          <tbody>
            {% for p in parkings %}
            <tr data-parking-id="{{ p.id }}" data-active="{{ 1 if p.active else 0 }}" data-occupied="{{ p.occupied_since or '' }}">
              <td class="fw-semibold parking-name" data-parking-id="{{ p.id }}">{{ p.name }}</td>
              <td class="text-muted small parking-status">{{ p.status or ( 'Libre' if p.active else 'Ocupado' ) }}</td>
              <td class="text-warning">$3.000 / 10min</td>
              <td class="text-muted small parking-time"><span id="time-{{ p.id }}">{% if p.occupied_since %}00:00:00{% else %}00:00:00{% endif %}</span></td>
              <td class="text-end">
                <div class="form-check form-switch d-inline-block">
                  <input class="form-check-input parking-toggle" type="checkbox" role="switch" data-parking-id="{{ p.id }}" id="switch{{ loop.index }}" {% if p.active %}checked{% endif %}>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal: Agregar parqueadero -->
    <div id="addParkingModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <button id="closeModal" class="modal-close"></button>
        <div class="modal-header text-center">
          <span class="badge btn-orange">Agregar parqueadero</span>
        </div>
        <form id="addParkingForm">
          <div class="modal-body">
            <div class="row g-2 mb-3">
              <div class="col-4"><input name="name" class="form-control" placeholder="Nombre Garaje"></div>
              <div class="col-4"><input name="phone" class="form-control" placeholder="Tel茅fono"></div>
              <div class="col-4"><input name="email" class="form-control" placeholder="Correo electr贸nico"></div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input name="address" class="form-control" placeholder="Direcci贸n"></div>
              <div class="col-4">
                <select id="add-department" name="department" class="form-control">
                  <option value="">Departamento</option>
                </select>
              </div>
              <div class="col-4">
                <select id="add-city" name="city" class="form-control">
                  <option value="">Ciudad / Municipio</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mb-3">
              <!-- Campos para coordenadas (latitud / longitud) -->
              <div class="col-6"><input name="latitude" class="form-control" placeholder="Latitud (ej: 4.60971)"></div>
              <div class="col-6"><input name="longitude" class="form-control" placeholder="Longitud (ej: -74.08175)"></div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input name="housing_type" class="form-control" placeholder="Tipo de vivienda"></div>
              <div class="col-4"><input name="size" class="form-control" placeholder="Medidas"></div>
              <div class="col-4"><input name="features" class="form-control" placeholder="Caracter铆sticas"></div>
            </div>

            <div class="d-flex justify-content-center my-3">
              <div class="upload-placeholder text-center">
                <div style="font-size:64px; opacity:0.2;"></div>
                <div class="text-muted">(foto)</div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between p-3" style="background:#FFEFE0; border-bottom-left-radius:8px; border-bottom-right-radius:8px;">
            <button type="button" id="cancelBtn" class="btn btn-outline-light">Cancelar</button>
            <button type="submit" class="btn btn-orange">Agregar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- removed Ver todos button per UX request -->
    <!-- Modal: Ver / Editar parqueadero (top-level) -->
    <div id="viewParkingModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <button id="closeViewModal" class="modal-close"></button>
        <div class="modal-header text-center">
          <span class="badge btn-orange">Detalle del parqueadero</span>
        </div>
        <form id="viewParkingForm">
          <div class="modal-body">
            <input type="hidden" name="id" id="vp-id">
            <div class="row g-2 mb-3">
              <div class="col-4"><input id="vp-name" name="name" class="form-control" placeholder="Nombre Garaje"></div>
              <div class="col-4"><input id="vp-phone" name="phone" class="form-control" placeholder="Tel茅fono"></div>
              <div class="col-4"><input id="vp-email" name="email" class="form-control" placeholder="Correo electr贸nico"></div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input id="vp-address" name="address" class="form-control" placeholder="Direcci贸n"></div>
              <div class="col-4">
                <select id="vp-department" name="department" class="form-control">
                  <option value="">Departamento</option>
                </select>
              </div>
              <div class="col-4">
                <select id="vp-city" name="city" class="form-control">
                  <option value="">Ciudad / Municipio</option>
                </select>
              </div>
            </div>

            <hr class="my-3"/>

            <div class="row g-2 mb-3">
              <div class="col-4"><input id="vp-housing_type" name="housing_type" class="form-control" placeholder="Tipo de vivienda"></div>
              <div class="col-4"><input id="vp-size" name="size" class="form-control" placeholder="Medidas"></div>
              <div class="col-4"><input id="vp-features" name="features" class="form-control" placeholder="Caracter铆sticas"></div>
            </div>

            <div class="row g-2 mb-3">
              <!-- Campos de coordenadas para edici贸n -->
              <div class="col-6"><input id="vp-latitude" name="latitude" class="form-control" placeholder="Latitud"></div>
              <div class="col-6"><input id="vp-longitude" name="longitude" class="form-control" placeholder="Longitud"></div>
            </div>

            <div class="d-flex justify-content-center my-3">
              <div id="vp-image-preview" class="upload-placeholder text-center">
                <div style="font-size:64px; opacity:0.2;"></div>
                <div class="text-muted">(foto)</div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between p-3" style="background:#FFEFE0; border-bottom-left-radius:8px; border-bottom-right-radius:8px;">
            <div>
              <button type="button" id="deleteParkingBtn" class="btn btn-outline-light">Eliminar</button>
            </div>
            <div>
              <button type="button" id="cancelViewBtn" class="btn btn-outline-light">Cancelar</button>
              <button type="submit" class="btn btn-orange">Guardar cambios</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notificaciones en el icono del cono -->
  <div id="notificationIcon" class="position-fixed" style="top: 20px; right: 20px; cursor: pointer;">
    <img src="{{ url_for('static', filename='img/cono.png') }}" alt="Notificaciones" style="width: 40px; height: 40px;">
    <span id="notificationCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
  </div>

  <!-- Modal de Notificaciones -->
  <!-- Ventana emergente de notificaciones -->
  <div id="notificationsModal" class="modal-overlay" aria-hidden="true" style="z-index:9999;">
    <div class="modal-card" role="dialog" aria-modal="true" style="max-width: 500px;">
      <button class="modal-close" id="closeModalBtn"></button>
      <div class="modal-header text-center">
        <span class="badge btn-orange">Notificaciones</span>
      </div>
      <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
        <div id="notificationsList">
          <!-- Las notificaciones se cargar谩n aqu铆 din谩micamente -->
        </div>
        <div class="text-center mt-3">
          <button id="clearMailboxBtnOwner" class="btn btn-outline-dark" onclick="clearNotificationsMailboxOwner()">Limpiar buz贸n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Finalizar servicio (arrendador) -->
  <div id="finishModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" style="max-width:480px;">
      <button class="modal-close" id="closeFinishModal"></button>
      <div class="modal-header text-center"><span class="badge btn-orange">Finalizar servicio</span></div>
      <div class="modal-body">
        <input type="hidden" id="finishReservationId">
        <div class="mb-2"><strong>Parqueadero:</strong> <span id="finishParkingName"></span></div>
        <div class="mb-2"><strong>Conductor:</strong> <span id="finishDriverName"></span></div>
        <div class="mb-2"><strong>Tiempo usado (min):</strong> <span id="finishElapsed">--</span></div>
        <div class="mb-2"><strong>Monto estimado:</strong> <span id="finishAmount">--</span></div>
        <hr>
        <div class="mb-2"><label>Calificaci贸n</label>
          <select id="finishRating" class="form-control" style="width:120px; display:inline-block;">
            <option value="">--</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
          </select>
        </div>
        <div class="mb-2"><label>Comentario (opcional)</label>
          <textarea id="finishComment" class="form-control" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-end p-3">
        <button id="cancelFinishBtn" class="btn btn-outline-light me-2">Cancelar</button>
        <button id="confirmFinishBtn" class="btn btn-orange">Finalizar y calificar</button>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-light">Cerrar sesi贸n</a>
  </div>
</main>

{% endblock %}

{% block scripts %}
<script>
let notifications = [];
// Evitar reintentos paralelos de cancelaci贸n
window.pendingCancels = window.pendingCancels || new Set();
// Cuando el usuario limpia el buz贸n, mantener solo botones hasta cerrar modal
window.preserveNotificationsButtonsOnly = window.preserveNotificationsButtonsOnly || false;
function updateNotificationCount() {
  const unreadCount = notifications.filter(n => n.status === 'unread').length;
  const countBadge = document.getElementById('notificationCount');
  if (countBadge) {
    countBadge.textContent = unreadCount;
    countBadge.style.display = unreadCount > 0 ? 'block' : 'none';
  }
}
function loadNotifications() {
  // Primero cargar reservas activas
  fetch('/api/reservations/active/owner')
    .then(response => response.json())
    .then(data => {
      let activeHtml = '';
      if (data.success && data.reservations && data.reservations.length > 0) {
        activeHtml = data.reservations.map(r => `
          <div class="notification-item active-reservation">
            <p>Reserva activa del garaje <strong>${r.parking_name}</strong> por <strong>${r.driver_name || 'un conductor'}</strong>.</p>
            <hr>
            <button class="btn btn-orange me-2" onclick="finishReservation(${r.id})">Finalizar</button>
            <button class="btn btn-outline-light" disabled>Detalles</button>
            <div class="mt-2 small text-muted">Tiempo restante: <span class="time-remaining" data-duration="${r.duration_minutes||0}" data-occupied="${r.occupied_since||''}" data-resid="${r.id}">--:--:--</span></div>
          </div>
        `).join('');
      }
      // Luego cargar notificaciones normales
      fetch('/api/notifications')
        .then(response => response.json())
        .then(data2 => {
          if (data2.success) {
            notifications = data2.notifications;
            updateNotificationCount();
            const notificationsList = document.getElementById('notificationsList');
            if (notificationsList) {
              let notifHtml = '';
              if (notifications.length === 0 && !activeHtml) {
                notifHtml = '<div class="text-center text-muted py-4">Buz贸n vac铆o</div>';
              } else {
                // Usar el mismo formato que en la vista conductor para consistencia
                function formatNotification(notification) {
                  let extra = {};
                  try { extra = JSON.parse(notification.extra_data || '{}'); } catch(e){}
                  let html = '';
                  if (notification.type === 'new_reservation') {
                    html += `<p>Tu garaje, <strong>${extra.parking_name || ''}</strong> fue reservado por <strong>${extra.driver_name || ''}</strong> y llegar谩 en <strong>${notification.eta || ''} minutos</strong>.</p>`;
                    html += `<hr><button class="btn btn-orange me-2" onclick="showDriverInfo(${extra.driver_id || 0})">Conductor</button><button class="btn btn-outline-light" onclick="cancelReservation(${notification.reservation_id})">Cancelar reserva</button>`;
                  } else if (notification.type === 'driver_arrived') {
                    // Usar el mensaje enviado por el servidor si est谩 disponible; si no, mostrar texto por defecto
                    html += `<p>${notification.message || 'El conductor no lleg贸 al garaje en el tiempo estimulado.'}</p>`;
                    html += `<hr><button class="btn btn-orange me-2" onclick="showDriverInfo(${extra.driver_id || 0})">Conductor</button><button class="btn btn-outline-light" onclick="cancelReservation(${notification.reservation_id})">Cancelar reserva</button>`;
                  } else if (notification.type === 'reservation_expired') {
                    // Notificaci贸n creada por el worker cuando el tiempo activo se acaba
                    html += `<p>${notification.message || 'El conductor no lleg贸 al garaje en el tiempo estimulado.'}</p>`;
                    html += `<hr><button class="btn btn-orange me-2" onclick="showDriverInfo(${extra.driver_id || 0})">Conductor</button><button class="btn btn-outline-light" onclick="cancelReservation(${notification.reservation_id})">Cancelar reserva</button>`;
                  } else if (notification.type === 'active_reservation') {
                    html += `<p>Tienes una reserva activa en <strong>${extra.parking_name || ''}</strong>. Debes llegar en <strong>${notification.eta || ''} minutos</strong>.</p>`;
                  } else {
                    html += `<p>${notification.message}</p>`;
                  }
                  return `<div class="notification-item ${notification.status === 'unread' ? 'unread' : ''}" data-id="${notification.id}">${html}</div>`;
                }
                notifHtml = notifications.map(formatNotification).join('');
              }
              notificationsList.innerHTML = activeHtml + notifHtml;
              // Se帽alamos que el render de notificaciones ha terminado
              document.dispatchEvent(new Event('notificationsLoaded'));
              // Si estamos en modo preservar solo botones, aplicarlo inmediatamente
              if (window.preserveNotificationsButtonsOnly) {
                keepOnlyButtonsInNotifications();
              }
            }
          }
        })
        .catch(error => console.error('Error cargando notificaciones:', error));
    })
    .catch(error => console.error('Error cargando reservas activas:', error));
}
function openNotificationsModal() {
  const modal = document.getElementById('notificationsModal');
  if (modal) {
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    loadNotifications();
    fetch('/api/notifications/mark-read', { method: 'POST' })
      .then(() => loadNotifications())
      .catch(error => console.error('Error marcando notificaciones como le铆das:', error));
  }
}
function closeNotificationsModal() {
  const modal = document.getElementById('notificationsModal');
  if (modal) {
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
    // Desactivar preservaci贸n cuando se cierra el modal
    window.preserveNotificationsButtonsOnly = false;
  }
}
// Mantener solo los botones/controles dentro de cada notificaci贸n (propietario)
function keepOnlyButtonsInNotifications() {
  const notificationsList = document.getElementById('notificationsList');
  if (!notificationsList) return;
  const items = Array.from(notificationsList.querySelectorAll('.notification-item, .active-reservation'));
  if (items.length === 0) return;
  items.forEach(it => {
    const buttons = Array.from(it.querySelectorAll('button'));
    if (buttons.length === 0) {
      it.remove();
      return;
    }
    const wrapper = document.createElement('div');
    wrapper.className = 'notification-controls d-flex gap-2';
    buttons.forEach(b => wrapper.appendChild(b));
    it.innerHTML = '';
    it.appendChild(wrapper);
  });
}

function clearNotificationsMailboxOwner() {
  if (!confirm('驴Eliminar todas las notificaciones no relacionadas con reservas?')) return;
  fetch('/api/notifications/clear', { method: 'POST' })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        // Marcar modo de preservaci贸n para que futuras recargas no restauren el texto
        window.preserveNotificationsButtonsOnly = true;
        // Actualizar datos en background y luego preservar solo los botones en el DOM
        loadNotifications();
        document.addEventListener('notificationsLoaded', function onLoaded(){
          keepOnlyButtonsInNotifications();
          alert('Buz贸n limpiado. Los m贸dulos interactivos se han preservado.');
        }, { once: true });
      } else {
        alert('Error borrando notificaciones: ' + (d.error || 'desconocido'));
      }
    })
    .catch(() => alert('Error de red al limpiar el buz贸n'));
}
function finishReservation(reservationId) {
  // Abrir modal de finalizaci贸n en lugar de finalizar directamente
  openFinishModal(reservationId);
}

// Modal: abrir con datos calculados (mismo rate que el backend: 100/unidad por minuto)
function openFinishModal(reservationId){
  // buscar informaci贸n de la reserva en la lista actual
  const span = document.querySelector(`#notificationsList .active-reservation [data-resid='${reservationId}']`);
  let parkingName = '';
  let driverName = '';
  let occupied = '';
  let duration = 0;
  if(span){
    const parent = span.closest('.active-reservation');
    parkingName = parent.querySelector('strong') ? parent.querySelector('strong').textContent : '';
    // intentar leer atributos
    occupied = span.dataset.occupied || '';
    duration = parseInt(span.dataset.duration || '0', 10) || 0;
    // intentar leer driver name desde el bloque
    const p = parent.querySelector('.mt-2') || parent.querySelector('p');
    if(p){
      const txt = p.textContent || '';
      // heur铆stica: 'por <driver>'
      const m = txt.match(/por\s+(.*)\./);
      if(m) driverName = m[1];
    }
  }
  // calcular elapsed
  let elapsed_min = duration;
  if(occupied){
    const start = Date.parse(occupied);
    if(!isNaN(start)){
      const secs = Math.floor((Date.now() - start)/1000);
      elapsed_min = Math.max(0, Math.ceil(secs/60));
    }
  }
  const rate = 100;
  const amount = elapsed_min * rate;

  // rellenar modal
  document.getElementById('finishReservationId').value = reservationId;
  document.getElementById('finishParkingName').textContent = parkingName || '';
  document.getElementById('finishDriverName').textContent = driverName || '';
  document.getElementById('finishElapsed').textContent = elapsed_min;
  document.getElementById('finishAmount').textContent = amount;
  document.getElementById('finishRating').value = '';
  document.getElementById('finishComment').value = '';

  const modal = document.getElementById('finishModal');
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}

// Modal event handlers
document.addEventListener('DOMContentLoaded', ()=>{
  const closeBtn = document.getElementById('closeFinishModal');
  const cancelBtn = document.getElementById('cancelFinishBtn');
  const confirmBtn = document.getElementById('confirmFinishBtn');
  const modal = document.getElementById('finishModal');
  if(closeBtn) closeBtn.addEventListener('click', ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
  if(cancelBtn) cancelBtn.addEventListener('click', ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
  if(confirmBtn) confirmBtn.addEventListener('click', async ()=>{
    const id = document.getElementById('finishReservationId').value;
    const rating = document.getElementById('finishRating').value;
    const comment = document.getElementById('finishComment').value;
    try{
      const res = await fetch(`/api/reservations/${id}/finish`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ rating: rating? parseInt(rating): null, comment: comment || null }) });
      const j = await res.json();
      if(res.ok && j.success){
        modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
        loadNotifications();
        alert('Reserva finalizada correctamente');
      } else {
        alert('Error finalizando: '+(j.error||'error'));
      }
    }catch(err){ alert('Error de red: '+err.message); }
  });
});
function showDriverInfo(driverId) {
  // Aqu铆 puedes mostrar un modal con la informaci贸n del conductor
  fetch(`/api/users/profile?user_id=${driverId}`)
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert(`Conductor: ${data.name}\nCorreo: ${data.email}\nTel茅fono: ${data.phone}`);
      } else {
        alert('No se pudo obtener la informaci贸n del conductor');
      }
    })
    .catch(() => alert('Error de red al consultar el conductor'));
}
function cancelReservation(reservationId) {
  if (!reservationId) return;
  if (window.pendingCancels && window.pendingCancels.has(reservationId)) return;
  if (!confirm('驴Est谩s seguro de que deseas cancelar la reserva?')) return;
  window.pendingCancels.add(reservationId);
  fetch(`/api/reservations/${reservationId}/cancel`, { method: 'POST' })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Reserva cancelada correctamente');
      loadNotifications();
    } else {
      alert('Error al cancelar la reserva: ' + data.error);
    }
  })
  .catch(error => alert('Error de red al cancelar la reserva'))
  .finally(()=>{ if(window.pendingCancels) window.pendingCancels.delete(reservationId); });
}
document.addEventListener('DOMContentLoaded', () => {
  loadNotifications();
  setInterval(loadNotifications, 10000);
  const notificationIcon = document.getElementById('notificationIcon');
  if (notificationIcon) {
    notificationIcon.addEventListener('click', openNotificationsModal);
  }
  const closeModalBtn = document.getElementById('closeModalBtn');
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeNotificationsModal);
  }
});

// Timers para actualizar tiempo restante dentro del modal de notificaciones
let _ownerNotifTimer = null;
function updateOwnerNotificationTimers(){
  const items = document.querySelectorAll('#notificationsList .active-reservation');
  items.forEach(it => {
    const span = it.querySelector('.time-remaining');
    if(!span) return;
    const duration = parseInt(span.dataset.duration || '0', 10) || 0;
    const occupied = span.dataset.occupied || '';
    if(!occupied){ span.textContent='--:--:--'; return; }
    const start = Date.parse(occupied);
    if(isNaN(start)){ span.textContent='--:--:--'; return; }
    const elapsed = Math.floor((Date.now() - start)/1000);
    const remaining = Math.max(0, duration*60 - elapsed);
    const hrs = Math.floor(remaining/3600);
    const mins = Math.floor((remaining%3600)/60);
    const secs = remaining%60;
    span.textContent = String(hrs).padStart(2,'0')+':'+String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
  });
}
document.addEventListener('notificationsLoaded', ()=>{
  if(_ownerNotifTimer) clearInterval(_ownerNotifTimer);
  updateOwnerNotificationTimers();
  _ownerNotifTimer = setInterval(updateOwnerNotificationTimers, 1000);
});
// stop when modal closed
const closeModalBtn = document.getElementById('closeModalBtn');
if(closeModalBtn) closeModalBtn.addEventListener('click', ()=>{ if(_ownerNotifTimer){ clearInterval(_ownerNotifTimer); _ownerNotifTimer=null; } });
</script>

<script>
// Timers para parqueaderos ocupados y refresco peri贸dico
function startParkingTimers(){
  const rows = document.querySelectorAll('tr[data-parking-id]');
  rows.forEach(row=>{
    const pid = row.getAttribute('data-parking-id');
    const active = row.getAttribute('data-active');
    const occupied = row.getAttribute('data-occupied');
    const timeSpan = document.getElementById('time-'+pid);
    // clear existing interval stored on element
    if(row._timer) { clearInterval(row._timer); row._timer = null; }
    if(active === '0' && occupied){
      // calcular desde occupied timestamp
      let start = Date.parse(occupied);
      if(isNaN(start)) start = Date.now();
      function update(){
        const diff = Date.now() - start;
        const hrs = Math.floor(diff/3600000);
        const mins = Math.floor((diff%3600000)/60000);
        const secs = Math.floor((diff%60000)/1000);
        const text = String(hrs).padStart(2,'0')+':'+String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
        if(timeSpan) timeSpan.textContent = text;
      }
      update();
      row._timer = setInterval(update, 1000);
      // update status text
      const statusEl = row.querySelector('.parking-status');
      if(statusEl) statusEl.textContent = 'Ocupado';
    } else {
      // ensure shows Libre and zeroed time
      const statusEl = row.querySelector('.parking-status');
      if(statusEl) statusEl.textContent = 'Libre';
      if(timeSpan) timeSpan.textContent = '00:00:00';
    }
  });

  function clearNotificationsMailboxOwner() {
    if (!confirm('驴Eliminar todas las notificaciones no relacionadas con reservas?')) return;
    fetch('/api/notifications/clear', { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          loadNotifications();
          alert('Buz贸n limpiado.');
        } else {
          alert('Error borrando notificaciones: ' + (d.error || 'desconocido'));
        }
      })
      .catch(() => alert('Error de red al limpiar el buz贸n'));
  }
}

// Polling para actualizar lista cada 8s (permite ver cambios tras reservas)
function pollOwnerParkings(){
  fetch('/api/owner/parkings')
    .then(r=>r.json())
    .then(data=>{
      if(!data.success) return;
      const parkings = data.parkings || [];
      parkings.forEach(p=>{
        const row = document.querySelector(`tr[data-parking-id="${p.id}"]`);
        if(!row) return;
        row.setAttribute('data-active', p.active? '1':'0');
        row.setAttribute('data-occupied', p.occupied_since || '');
      });
      startParkingTimers();
    }).catch(()=>{});
}

document.addEventListener('DOMContentLoaded', ()=>{
  // iniciar timers en la carga
  startParkingTimers();
  // comenzar polling
  setInterval(pollOwnerParkings, 8000);
});

// Modal open/close
const openBtn = document.getElementById('openAddParking');
const modal = document.getElementById('addParkingModal');
const closeBtn = document.getElementById('closeModal');
const cancelBtn = document.getElementById('cancelBtn');
const form = document.getElementById('addParkingForm');

// debug badge (visible when modal opens)
let debugBadge = document.getElementById('modalDebug');
if(!debugBadge){
  debugBadge = document.createElement('div');
  debugBadge.id = 'modalDebug';
  debugBadge.style.position = 'fixed';
  debugBadge.style.right = '12px';
  debugBadge.style.bottom = '12px';
  debugBadge.style.background = '#FFB300';
  debugBadge.style.color = '#111';
  debugBadge.style.padding = '6px 10px';
  debugBadge.style.borderRadius = '6px';
  debugBadge.style.display = 'none';
  debugBadge.style.zIndex = 9999;
  document.body.appendChild(debugBadge);
}

function openModal(){
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  // show debug badge briefly
  debugBadge.textContent = 'modal abierto';
  debugBadge.style.display = 'block';
  setTimeout(()=> debugBadge.style.display = 'none', 2000);
}
function closeModal(){
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
}
openBtn && openBtn.addEventListener('click', openModal);
closeBtn && closeBtn.addEventListener('click', closeModal);
cancelBtn && cancelBtn.addEventListener('click', closeModal);

// Submit via fetch (with inline validation and insertion without reload)
form && form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const submitBtn = form.querySelector('button[type="submit"]');
  const data = new FormData(form);
  // Basic client-side validation
  if(!data.get('name') || !data.get('name').trim()){
    alert('Por favor ingresa el nombre del parqueadero.');
    return;
  }
  // Validar que departamento y ciudad est茅n seleccionados
  if(!data.get('department') || !data.get('department').trim()){
    alert('Por favor selecciona un departamento.');
    return;
  }
  if(!data.get('city') || !data.get('city').trim()){
    alert('Por favor selecciona una ciudad.');
    return;
  }
  try{
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';
    const res = await fetch('/parkings/create', { method: 'POST', body: data });
    const json = await res.json();
    if(res.ok && json.success){
      const parking = json.parking;
      insertParkingRow(parking);
      closeModal();
      form.reset();
      if(json.geocode_failed){
        alert(json.message || 'La geocodificaci贸n no encontr贸 coordenadas; por favor edita el parqueadero y agrega latitud/longitud manualmente.');
      }
    } else {
      alert('Error al crear parqueadero: '+(json.error||'error'));
    }
  } catch(err){
    alert('Error de red: '+err.message);
  } finally{
    submitBtn.disabled = false;
    submitBtn.textContent = 'Agregar';
  }
});

function insertParkingRow(p){
  try{
    const tbody = document.querySelector('.parkings-table tbody');
    if(!tbody) return;
    const tr = document.createElement('tr');
    tr.setAttribute('data-parking-id', p.id);
    tr.innerHTML = `
      <td class="fw-semibold parking-name" data-parking-id="${p.id}">${escapeHtml(p.name || '')}</td>
      <td class="text-muted small">${p.status || 'Libre'}</td>
      <td class="text-warning">$3.000 / 10min</td>
      <td class="text-muted small"><span id="time-${p.id}">00:00:00</span></td>
      <td class="text-end">
        <div class="form-check form-switch d-inline-block">
          <input class="form-check-input parking-toggle" type="checkbox" role="switch" data-parking-id="${p.id}" id="switch-new-${p.id}" ${p.active? 'checked':''}>
        </div>
      </td>
    `;
    // Prepend the new row so newest appear on top
    tbody.prepend(tr);
  }catch(err){
    console.error('insertParkingRow error', err);
  }
}

function escapeHtml(unsafe){
  return unsafe
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/\"/g, "&quot;")
       .replace(/'/g, "&#039;");
}

</script>

<script>
// View / Edit modal logic
const viewModal = document.getElementById('viewParkingModal');
const closeView = document.getElementById('closeViewModal');
const cancelViewBtn = document.getElementById('cancelViewBtn');
const viewForm = document.getElementById('viewParkingForm');
const deleteBtn = document.getElementById('deleteParkingBtn');

function openViewModal(){
  viewModal.classList.add('open');
  viewModal.setAttribute('aria-hidden','false');
}
function closeViewModal(){
  viewModal.classList.remove('open');
  viewModal.setAttribute('aria-hidden','true');
}
closeView && closeView.addEventListener('click', closeViewModal);
cancelViewBtn && cancelViewBtn.addEventListener('click', closeViewModal);

// When clicking on a parking name, fetch details and open modal
document.addEventListener('click', async (e)=>{
  // Ensure we handle clicks on text nodes as well
  let node = e.target;
  if(node && node.nodeType === 3) node = node.parentElement;
  const el = node && node.closest ? node.closest('.parking-name') : null;
  if(!el) return;
  const pid = el.getAttribute('data-parking-id') || el.dataset.parkingId;
  try{
    // debug visibility
    console.log('parking-name clicked, id=', pid, 'el=', el);
    if(debugBadge){ debugBadge.textContent = `click ${pid}`; debugBadge.style.display='block'; setTimeout(()=> debugBadge.style.display='none',900); }
    if(!viewModal){ console.error('viewModal element not found'); }
    const res = await fetch(`/parkings/${pid}`);
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'error');
    const p = j.parking;
    // populate form
    document.getElementById('vp-id').value = p.id;
    document.getElementById('vp-name').value = p.name || '';
    document.getElementById('vp-phone').value = p.phone || '';
    document.getElementById('vp-email').value = p.email || '';
    document.getElementById('vp-address').value = p.address || '';
    document.getElementById('vp-department').value = p.department || '';
    document.getElementById('vp-city').value = p.city || '';
    document.getElementById('vp-housing_type').value = p.housing_type || '';
    document.getElementById('vp-size').value = p.size || '';
    document.getElementById('vp-features').value = p.features || '';
    // image preview
    const imgPreview = document.getElementById('vp-image-preview');
    if(p.image_path){
      imgPreview.innerHTML = `<img src="${p.image_path}" alt="img" style="max-width:160px; max-height:120px; border-radius:6px;">`;
    } else {
      imgPreview.innerHTML = `<div style="font-size:64px; opacity:0.2;"></div><div class="text-muted">(foto)</div>`;
    }
    openViewModal();
  }catch(err){
    alert('Error cargando detalle: '+err.message);
  }
});

// Submit update
viewForm && viewForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const pid = document.getElementById('vp-id').value;
  const data = new FormData(viewForm);
  try{
    const res = await fetch(`/parkings/${pid}/update`, { method: 'POST', body: data });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'error');
    const p = j.parking;
    // update row in table
    const row = document.querySelector(`tr[data-parking-id="${p.id}"]`);
    if(row){
      const nameTd = row.querySelector('.parking-name');
      if(nameTd) nameTd.textContent = p.name || '';
    }
    closeViewModal();
    if(j.geocode_failed){
      alert(j.message || 'La geocodificaci贸n no encontr贸 coordenadas; por favor agrega latitud/longitud manualmente.');
    }
  }catch(err){
    alert('Error actualizando: '+err.message);
  }
});

// Delete
deleteBtn && deleteBtn.addEventListener('click', async ()=>{
  if(!confirm('驴Eliminar este parqueadero? Esta acci贸n no se puede deshacer.')) return;
  const pid = document.getElementById('vp-id').value;
  try{
  const res = await fetch(`/api/parkings/${pid}/delete`, { method: 'POST' });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'error');
    // remove row
    const row = document.querySelector(`tr[data-parking-id="${pid}"]`);
    if(row && row.parentNode) row.parentNode.removeChild(row);
    closeViewModal();
  }catch(err){
    alert('Error eliminando: '+err.message);
  }
});
</script>

<script>
// Cargar lista de departamentos/ciudades y poblar selects del modal Agregar/Editar
document.addEventListener('DOMContentLoaded', ()=>{
  const deptSelects = [document.getElementById('add-department'), document.getElementById('vp-department')];
  const citySelects = [document.getElementById('add-city'), document.getElementById('vp-city')];

  fetch('/static/data/colombia_locations.json')
    .then(r => r.json())
    .then(data => {
      const departments = Object.keys(data).sort();
      deptSelects.forEach(sel => {
        if(!sel) return;
        // limpiar excepto la opci贸n por defecto
        sel.innerHTML = '<option value="">Departamento</option>';
        departments.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sel.appendChild(opt);
        });
        // si existe un valor prellenado (ej. en edici贸n), intentar seleccionarlo
        if(sel.dataset && sel.dataset.selected){
          sel.value = sel.dataset.selected;
        }
        sel.addEventListener('change', (e)=>{
          const dep = e.target.value;
          const cities = data[dep] || [];
          // encontrar el city select correspondiente (match by id prefix: add- vs vp-)
          const id = e.target.id.startsWith('add-') ? 'add-city' : 'vp-city';
          const citySel = document.getElementById(id);
          if(!citySel) return;
          citySel.innerHTML = '<option value="">Ciudad / Municipio</option>';
          cities.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; citySel.appendChild(o); });
        });
      });

      // Cuando se abre el view modal, si el departamento ya est谩 en el registro, poblar ciudades
      const openView = document.querySelectorAll('.parking-name');
    })
    .catch(err=>{ console.warn('No se pudo cargar lista de departamentos/ciudades:', err); });

  // Cuando se abre el view modal (click en nombre), se llenan selects si es necesario (el flujo existente
  // asigna los valores en los inputs; aqu铆 nos aseguramos de que las opciones existan y se seleccionen)
  document.addEventListener('click', async (e)=>{
    let node = e.target;
    if(node && node.nodeType === 3) node = node.parentElement;
    const el = node && node.closest ? node.closest('.parking-name') : null;
    if(!el) return;
    const pid = el.getAttribute('data-parking-id') || el.dataset.parkingId;
    try{
      const res = await fetch(`/parkings/${pid}`);
      const j = await res.json();
      if(!res.ok) throw new Error(j.error||'error');
      const p = j.parking;
      // Asegurar selects poblados
      const depSel = document.getElementById('vp-department');
      const citySel = document.getElementById('vp-city');
      if(depSel){
        depSel.value = p.department || '';
        // disparar evento change para poblar ciudades
        const ev = new Event('change');
        depSel.dispatchEvent(ev);
        // esperar un tick y seleccionar ciudad si existe
        setTimeout(()=>{ if(citySel){ citySel.value = p.city || ''; } }, 50);
      }
    }catch(err){ /* no bloquear la UI */ }
  });
});
</script>

<script>
// Toggle active handler: send POST JSON to /parkings/<id>/active
document.addEventListener('change', async (e)=>{
  const t = e.target;
  if(t && t.classList && t.classList.contains('parking-toggle')){
    const pid = t.dataset.parkingId;
    const active = t.checked;
    try{
      const res = await fetch(`/parkings/${pid}/active`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({active})});
      const j = await res.json();
      if(!res.ok) throw new Error(j.error||'error');
      // optionally show little feedback
      debugBadge.textContent = `parking ${pid} active=${j.active}`;
      debugBadge.style.display = 'block';
      setTimeout(()=> debugBadge.style.display='none', 1200);
    } catch(err){
      alert('Error actualizando active: '+err.message);
      // revert switch
      t.checked = !active;
    }
  }
});
</script>
{% endblock %}
