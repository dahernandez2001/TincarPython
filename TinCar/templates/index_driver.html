{% extends 'layout.html' %}

{% block content %}
<!-- Navbar dentro del contenido -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 py-3 border-bottom border-secondary">
  <div class="container-fluid">
  <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="logo" width="45" class="me-2">
      <span class="fs-4 fw-bold text-warning">TinCar</span>
    </a>
    <div class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav">
  <li class="nav-item"><a class="nav-link active" href="{{ url_for('home') }}">Inicio</a></li>
  <li class="nav-item"><a class="nav-link" href="{{ url_for('home') }}">Arrendar</a></li>
  <li class="nav-item"><a class="nav-link" href="{{ url_for('home') }}">Configuraci√≥n</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container py-5 text-light">
  <!-- Notificaciones -->
  <div id="notificationIcon" class="position-fixed" style="top: 20px; right: 20px; cursor: pointer;">
    <img src="{{ url_for('static', filename='img/cono.png') }}" alt="Notificaciones" style="width: 40px; height: 40px;">
    <span id="notificationCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
  </div>

  <!-- Modal de Notificaciones -->
  <div id="notificationsModal" class="modal-overlay" aria-hidden="true" style="z-index:9999;">
    <div class="modal-card" role="dialog" aria-modal="true" style="max-width: 500px;">
      <button class="modal-close" id="closeModalBtn">√ó</button>
      <div class="modal-header text-center">
        <span class="badge btn-orange">Notificaciones</span>
      </div>
      <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
        <div id="notificationsList">
          <!-- Las notificaciones se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Bienvenida -->
  <div class="text-center mb-4">
    <h1 class="fw-bold" style="color: #FFB300;">Bienvenido, {{ session.get('user_name') or session.get('name') or 'Usuario' }}</h1>
    <h5 class="text-secondary">
      Est√°s registrado como <span class="fw-semibold text-info">Conductor</span>.
    </h5>
  </div>

  <!-- Tarjeta principal -->
  <div class="card bg-black text-light p-4 rounded-4 shadow-lg border border-secondary mx-auto" style="max-width: 900px;">
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
      <div>
        <h2 class="fw-bold">Modo conductor</h2>
        <p class="text-secondary">({{ session.get('user_name') or session.get('name') or 'nombre de usuario' }})</p>
      </div>

      <div class="d-flex align-items-center mt-3 mt-md-0">
        <div class="info-box text-center me-4">
          <div class="bg-secondary bg-opacity-25 p-3 rounded-4">
            <p class="mb-1">Calificaci√≥n</p>
            <p class="fs-4 mb-0 text-warning">‚≠ê <span id="rating-sum">0</span></p>
            <hr class="text-secondary my-2">
            <p class="mb-1">Reservas</p>
            <p class="fs-4 mb-0"><span id="reservations-count">0</span></p>
          </div>
        </div>
        <div class="text-center">
          <div class="profile-circle mx-auto mb-2"></div>
          <a href="{{ url_for('dashboard') }}" class="btn btn-warning fw-bold rounded-3 px-4">Perfil</a>
        </div>
      </div>
    </div>

    <!-- Mapa -->
      <!-- Mapa: usaremos Leaflet para mostrar los parqueaderos activos -->
      <div class="map-container">
        <div id="map" style="width:100%; height:400px; border-radius:8px; overflow:hidden;"></div>
      </div>
  </div>

  <!-- Bot√≥n cerrar sesi√≥n -->
  <div class="mt-5 text-center">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-light px-4 py-2">
      Cerrar sesi√≥n
    </a>
  </div>
</main>

<!-- Modal para detalle de parqueadero (Conductor) - organizado como Agregar parqueadero -->
<div id="driverParkingModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <button id="closeDriverModal" class="modal-close">√ó</button>
    <div class="modal-header text-center">
      <span class="badge btn-orange">Detalle del parqueadero</span>
    </div>
    <form id="driverParkingForm">
      <div class="modal-body">
        <input type="hidden" id="dp-id">

        <div class="row g-2 mb-3">
          <div class="col-4"><input id="dp-name" class="form-control" placeholder="Nombre Garaje" disabled></div>
          <div class="col-4"><input id="dp-phone" class="form-control" placeholder="Tel√©fono" disabled></div>
          <div class="col-4"><input id="dp-email" class="form-control" placeholder="Correo electr√≥nico" disabled></div>
        </div>

        <hr class="my-3"/>

        <div class="row g-2 mb-3">
          <div class="col-4"><input id="dp-address" class="form-control" placeholder="Direcci√≥n" disabled></div>
          <div class="col-4"><input id="dp-department" class="form-control" placeholder="Departamento" disabled></div>
          <div class="col-4"><input id="dp-city" class="form-control" placeholder="Ciudad / Municipio" disabled></div>
        </div>

        <hr class="my-3"/>

        <div class="row g-2 mb-3">
          <div class="col-6"><input id="dp-latitude" class="form-control" placeholder="Latitud" disabled></div>
          <div class="col-6"><input id="dp-longitude" class="form-control" placeholder="Longitud" disabled></div>
        </div>

        <hr class="my-3"/>

        <div class="row g-2 mb-3">
          <div class="col-4"><input id="dp-housing_type" class="form-control" placeholder="Tipo de vivienda" disabled></div>
          <div class="col-4"><input id="dp-size" class="form-control" placeholder="Medidas" disabled></div>
          <div class="col-4"><input id="dp-features" class="form-control" placeholder="Caracter√≠sticas" disabled></div>
        </div>

        <div class="d-flex justify-content-center my-3">
          <div id="dp-image" class="upload-placeholder text-center" style="width:160px; height:120px;">
            <div style="font-size:48px; opacity:0.2;">üè†</div>
          </div>
        </div>
        <div id="dp-reservation-info" class="text-muted small mb-2" style="text-align:center"></div>
      </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label small text-secondary">Duraci√≥n (min)</label>
            <select id="dp-duration" class="form-control" aria-label="Duraci√≥n" >
              <option value="10">10 min</option>
              <option value="20">20 min</option>
              <option value="30">30 min</option>
              <option value="60">60 min</option>
              <option value="120">120 min</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small text-secondary">Llegar√© en (min)</label>
            <input id="dp-eta" type="number" min="0" value="5" class="form-control" aria-label="ETA en minutos">
          </div>
        </div>

      <div class="modal-footer d-flex justify-content-between p-3" style="background:#FFEFE0; border-bottom-left-radius:8px; border-bottom-right-radius:8px;">
        <button type="button" id="dp-cancel" class="btn btn-outline-light">Cancelar</button>
        <button type="button" id="dp-reserve" class="btn btn-orange">Reservar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- Leaflet JS (mapas) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{{ url_for('static', filename='js/driver.js') }}"></script>

  <script>
    // Funciones para el manejo de notificaciones
    let notifications = [];

    function updateNotificationCount() {
        const unreadCount = notifications.filter(n => n.status === 'unread').length;
        const countBadge = document.getElementById('notificationCount');
        if (countBadge) {
            countBadge.textContent = unreadCount;
            countBadge.style.display = unreadCount > 0 ? 'block' : 'none';
        }
    }

    function formatNotification(notification) {
    let extra = {};
    try { extra = JSON.parse(notification.extra_data || '{}'); } catch(e){}
    let html = '';
    if (notification.type === 'active_reservation') {
      html += `<p>Reservaste un garaje, recuerda llegar antes de <strong>${notification.eta || ''} minutos</strong>.</p>`;
      html += `<hr><button class=\"btn btn-orange\" onclick=\"showGarageInfo(${notification.parking_id || 0})\">Garaje</button><button class=\"btn btn-outline-light\" onclick=\"cancelReservation(${notification.reservation_id})\">Cancelar reserva</button>`;
    } else if (notification.type === 'arrived_confirmation') {
      html += `<p>No llegaste al garaje en el tiempo estimulado.</p>`;
      html += `<hr><button class=\"btn btn-orange\" onclick=\"showGarageInfo(${notification.parking_id || 0})\">Garaje</button><button class=\"btn btn-outline-light\" onclick=\"cancelReservation(${notification.reservation_id})\">Cancelar reserva</button>`;
    } else {
      html += `<p>${notification.message}</p>`;
    }
    return `<div class=\"notification-item ${notification.status === 'unread' ? 'unread' : ''}\" data-id=\"${notification.id}\">${html}</div>`;
    }

  function loadNotifications() {
      // Primero cargar reservas activas
      fetch('/api/reservations/active/driver')
        .then(response => response.json())
        .then(data => {
          let activeHtml = '';
          if (data.success && data.reservations && data.reservations.length > 0) {
            activeHtml = data.reservations.map(r => `
              <div class="notification-item active-reservation">
                <p>Reserva activa del garaje <strong>${r.parking_name}</strong>.</p>
                <hr>
                <button class="btn btn-orange" onclick="finishReservation(${r.id})">Finalizar</button>
                <button class="btn btn-outline-light" disabled>Detalles</button>
              </div>
            `).join('');
          }
          // Luego cargar notificaciones normales
          fetch('/api/notifications')
            .then(response => response.json())
            .then(data2 => {
              if (data2.success) {
                notifications = data2.notifications;
                updateNotificationCount();
                const notificationsList = document.getElementById('notificationsList');
                if (notificationsList) {
                  let notifHtml = '';
                  if (notifications.length === 0 && !activeHtml) {
                    notifHtml = '<div class="text-center py-4" style="color:#939393;">Buz√≥n vac√≠o</div>';
                  } else {
                    notifHtml = notifications.map(formatNotification).join('');
                  }
                  notificationsList.innerHTML = activeHtml + notifHtml;
                }
              }
            })
            .catch(error => console.error('Error cargando notificaciones:', error));
        })
        .catch(error => console.error('Error cargando reservas activas:', error));
  }
  window.loadNotifications = loadNotifications;

    // Funciones de acci√≥n para las notificaciones
    function markAsArrived(reservationId) {
        fetch(`/api/reservations/${reservationId}/arrived`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNotifications();
            } else {
                alert('Error al marcar llegada: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

  function showGarageInfo(parkingId) {
    // Mostrar informaci√≥n del garaje en un modal o alerta
    fetch(`/api/parkings/${parkingId}`)
      .then(r => r.json())
      .then(data => {
        if (data.id || (data.success && data.parking)) {
          const p = data.parking || data;
          alert(`Garaje: ${p.name}\nDirecci√≥n: ${p.address}\nTel√©fono: ${p.phone}`);
        } else {
          alert('No se pudo obtener la informaci√≥n del garaje');
        }
      })
      .catch(() => alert('Error de red al consultar el garaje'));
  }

  function cancelReservation(reservationId) {
    if (confirm('¬øEst√°s seguro de que deseas cancelar la reserva?')) {
      fetch(`/api/reservations/${reservationId}/cancel`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Reserva cancelada correctamente');
          loadNotifications();
        } else {
          alert('Error al cancelar la reserva: ' + data.error);
        }
      })
      .catch(() => alert('Error de red al cancelar la reserva'));
    }
  }

    function finishReservation(reservationId) {
        if (confirm('¬øEst√°s seguro de que deseas finalizar la reserva?')) {
            fetch(`/api/reservations/${reservationId}/finish`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotifications();
                } else {
                    alert('Error al finalizar la reserva: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    // Funciones del modal
    function openNotificationsModal() {
        const modal = document.getElementById('notificationsModal');
        if (modal) {
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            loadNotifications();
            // Marcar todas como le√≠das
            fetch('/api/notifications/mark-read', { method: 'POST' })
                .then(() => loadNotifications())
                .catch(error => console.error('Error marcando notificaciones como le√≠das:', error));
        }
    }

    function closeNotificationsModal() {
        const modal = document.getElementById('notificationsModal');
        if (modal) {
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
        }
    }

  document.addEventListener('DOMContentLoaded', () => {
    loadNotifications();
    setInterval(loadNotifications, 10000);
    const notificationIcon = document.getElementById('notificationIcon');
    if (notificationIcon) {
      notificationIcon.addEventListener('click', openNotificationsModal);
    }
    const closeModalBtn = document.getElementById('closeModalBtn');
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeNotificationsModal);
    }
  });
  </script>
{% endblock %}
