{% extends 'layout.html' %}

{% block content %}
<!-- Navbar dentro del contenido -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 py-3 border-bottom border-secondary">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="logo" style="height:44px; margin-right:14px;">
      <span class="fs-4 fw-bold text-warning">TinCar</span>
    </a>
    <div class="collapse navbar-collapse justify-content-end">
      <div class="nav">
        <a class="nav-link" href="{{ url_for('home') }}">Inicio</a>
        <a class="nav-link" href="{{ url_for('home') }}">Arrendar</a>
        <a class="nav-link" href="{{ url_for('home') }}">Configuraci√≥n</a>
        <div class="nav-bubble"></div>
      </div>
    </div>
  </div>
</nav>

<!-- Cono de notificaciones flotante -->
<div id="notificationIcon" class="notification-cone-fixed" onclick="openNotificationsModal()">
  <img src="{{ url_for('static', filename='img/cono.png') }}" alt="Notificaciones">
  <span id="notificationCount" class="notification-badge-cone">0</span>
</div>

<main class="container py-5 text-light">

  <!-- Modal de Notificaciones -->
  <div id="notificationsModal" class="modal-overlay" aria-hidden="true" style="z-index:9999;">
    <div class="modal-card" role="dialog" aria-modal="true" style="max-width: 500px;">
      <button class="modal-close" id="closeModalBtn">√ó</button>
      <div class="modal-header text-center">
        <span class="badge btn-orange">Notificaciones</span>
      </div>
      <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
        <div id="notificationsList">
          <!-- Las notificaciones se cargar√°n aqu√≠ din√°micamente -->
        </div>
        <div class="text-center mt-3">
          <button id="clearMailboxBtn" class="btn btn-outline-light" onclick="clearNotificationsMailbox()">Limpiar buz√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bienvenida -->
  <div class="text-center mb-4">
    <h1 class="fw-bold" style="color: #FFB300;">Bienvenido, {{ session.get('user_name') or session.get('name') or 'Usuario' }}</h1>
  </div>

  <!-- Tarjeta principal -->
  <div class="card bg-black text-light p-4 rounded-4 shadow-lg border border-secondary mx-auto" style="max-width: 900px;">
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
      <div>
        <h2 class="fw-bold">Modo conductor</h2>
        <p class="text-secondary">Selecciona un parqueadero</p>
      </div>

      <div class="d-flex align-items-center mt-3 mt-md-0">
        <div class="info-box text-center me-4">
          <div class="bg-secondary bg-opacity-25 p-3 rounded-4">
            <p class="mb-1">Calificaci√≥n</p>
            <p class="fs-4 mb-0 text-warning">‚≠ê <span id="rating-sum">0</span></p>
            <hr class="text-secondary my-2">
            <p class="mb-1">Reservas</p>
            <p class="fs-4 mb-0"><span id="reservations-count">0</span></p>
          </div>
        </div>
        <div class="text-center">
          <div class="profile-circle mx-auto mb-2"></div>
          <a href="{{ url_for('dashboard') }}" class="btn btn-warning fw-bold rounded-3 px-4">Perfil</a>
        </div>
      </div>
    </div>

    <!-- Mapa -->
      <!-- Mapa: usaremos Leaflet para mostrar los parqueaderos activos -->
      <div class="map-container">
        <div id="map" style="width:100%; height:400px; border-radius:8px; overflow:hidden;"></div>
      </div>
  </div>

  <!-- Bot√≥n cerrar sesi√≥n -->
  <div class="mt-5 text-center">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-light px-4 py-2">
      Cerrar sesi√≥n
    </a>
  </div>
</main>

<!-- Modal para detalle de parqueadero (Conductor) - organizado como Agregar parqueadero -->
<div id="driverParkingModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <button id="closeDriverModal" class="modal-close">√ó</button>
    <div class="modal-header text-center">
      <span class="badge btn-orange">Detalle del parqueadero</span>
    </div>
    <form id="driverParkingForm">
      <div class="modal-body">
        <input type="hidden" id="dp-id">

        <div class="row g-2 mb-3">
          <div class="col-4"><input id="dp-name" class="form-control" placeholder="Nombre Garaje" disabled></div>
          <div class="col-4"><input id="dp-phone" class="form-control" placeholder="Tel√©fono" disabled></div>
          <div class="col-4"><input id="dp-email" class="form-control" placeholder="Correo electr√≥nico" disabled></div>
        </div>

        <hr class="my-3"/>

        <div class="row g-2 mb-3">
          <div class="col-4"><input id="dp-address" class="form-control" placeholder="Direcci√≥n" disabled></div>
          <div class="col-4"><input id="dp-department" class="form-control" placeholder="Departamento" disabled></div>
          <div class="col-4"><input id="dp-city" class="form-control" placeholder="Ciudad / Municipio" disabled></div>
        </div>

        <hr class="my-3"/>

        <div class="row g-2 mb-3">
          <div class="col-6"><input id="dp-latitude" class="form-control" placeholder="Latitud" disabled></div>
          <div class="col-6"><input id="dp-longitude" class="form-control" placeholder="Longitud" disabled></div>
        </div>

        <hr class="my-3"/>

        <div class="row g-2 mb-3">
          <div class="col-4"><input id="dp-housing_type" class="form-control" placeholder="Tipo de vivienda" disabled></div>
          <div class="col-4"><input id="dp-size" class="form-control" placeholder="Medidas" disabled></div>
          <div class="col-4"><input id="dp-features" class="form-control" placeholder="Caracter√≠sticas" disabled></div>
        </div>

        <div class="d-flex justify-content-center my-3">
          <div id="dp-image" class="upload-placeholder text-center" style="width:160px; height:120px;">
            <div style="font-size:48px; opacity:0.2;">üè†</div>
          </div>
        </div>
        <div id="dp-reservation-info" class="text-muted small mb-2" style="text-align:center"></div>
      </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label small text-secondary">Duraci√≥n (min)</label>
            <select id="dp-duration" class="form-control" aria-label="Duraci√≥n" >
              <option value="10">10 min</option>
              <option value="20">20 min</option>
              <option value="30">30 min</option>
              <option value="60">60 min</option>
              <option value="120">120 min</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small text-secondary">Llegar√© en (min)</label>
            <input id="dp-eta" type="number" min="0" value="5" class="form-control" aria-label="ETA en minutos">
          </div>
        </div>

      <div class="modal-footer d-flex justify-content-between p-3" style="background:#1A1919; border-bottom-left-radius:8px; border-bottom-right-radius:8px;">
        <button type="button" id="dp-cancel" class="btn btn-outline-light">Cancelar</button>
        <button type="button" id="dp-reserve" class="btn btn-orange">Reservar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- Leaflet JS (mapas) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{{ url_for('static', filename='js/driver.js') }}"></script>

  {% raw %}
  <script>
  // Animaci√≥n de burbuja en navegaci√≥n
  document.addEventListener('DOMContentLoaded', () => {
    const nav = document.querySelector('.nav');
    if (nav) {
      const bubble = document.querySelector('.nav-bubble');
      const links = nav.querySelectorAll('a.nav-link');
      
      links.forEach(link => {
        link.addEventListener('mouseenter', () => {
          const rect = link.getBoundingClientRect();
          const navRect = nav.getBoundingClientRect();
          
          bubble.style.left = (rect.left - navRect.left) + 'px';
          bubble.style.width = rect.width + 'px';
          bubble.style.height = rect.height + 'px';
        });
      });
      
      nav.addEventListener('mouseleave', () => {
        bubble.style.width = '0';
      });
    }
  });

  // Funciones para el manejo de notificaciones
  let notifications = [];
  // Evitar reintentos paralelos de cancelaci√≥n
  window.pendingCancels = window.pendingCancels || new Set();
  // Cuando el usuario limpia el buz√≥n, mantener solo botones hasta cerrar modal
  window.preserveNotificationsButtonsOnly = window.preserveNotificationsButtonsOnly || false;

    function updateNotificationCount() {
        const unreadCount = notifications.filter(n => n.status === 'unread').length;
        const countBadge = document.getElementById('notificationCount');
        if (countBadge) {
            countBadge.textContent = unreadCount;
            countBadge.style.display = unreadCount > 0 ? 'block' : 'none';
        }
    }

    function formatNotification(notification) {
    let extra = {};
    try { extra = JSON.parse(notification.extra_data || '{}'); } catch(e){}
    let html = '';
    
    // ========== SEGUNDA INTERFAZ: RESERVA ACTIVA ==========
    if (notification.type === 'vehicle_parked') {
      // Veh√≠culo guardado - mostrar tiempo restante de reserva
      const dur = extra.duration_minutes || notification.duration_minutes || 0;
      const occ = extra.occupied_since || notification.occupied_since || '';
      const resId = notification.reservation_id || extra.reservation_id || 0;
      html += `<div class="interface-header segunda" style="background-color: #2C2C2C; color: #FFB300; border-color: #E88E2E;">RESERVA ACTIVA</div>`;
      html += `<p>Tu veh√≠culo est√° guardado, te queda <span class="time-remaining" data-duration="${dur}" data-occupied="${occ}" style="display: inline-block; min-width: 65px; text-align: center;">--:--:--</span></p>`;
      html += `<hr>`;
      html += `<button class="btn btn-warning me-2" onclick="requestExtraTime(${resId})">M√°s tiempo</button>`;
      html += `<button class="btn btn-success" onclick="notifyAtVehicle(${resId})">Estoy en mi veh√≠culo</button>`;
      return `<div class="notification-item interface-segunda ${notification.status === 'unread' ? 'unread' : ''}" data-id="${notification.id}">${html}</div>`;
    } 
    // ========== PRIMERA INTERFAZ: ETA EXPIRADO ==========
    else if (notification.type === 'eta_expired') {
      html += `<div class="interface-header" style="background-color: #E88E2E; color: #1A1919;">TIEMPO AGOTADO</div>`;
      html += `<p>No has llegado al parqueadero.</p>`;
      html += `<hr>`;
      html += `<button class="btn btn-warning me-2" onclick="showGarageInfo(${notification.parking_id || 0})">Ver garaje</button>`;
      html += `<button class="btn btn-outline-light" onclick="cancelReservation(${notification.reservation_id})">Cancelar reserva</button>`;
      return `<div class="notification-item interface-primera ${notification.status === 'unread' ? 'unread' : ''}" data-id="${notification.id}">${html}</div>`;
    } 
    // ========== SEGUNDA INTERFAZ: RESPUESTAS DE TIEMPO EXTRA ==========
    else if (notification.type === 'extra_time_approved') {
      const ownerName = extra.owner_name || 'El arrendador';
      html += `<div class="alert alert-success mb-0">`;
      html += `<p class="mb-0"><strong>${ownerName}</strong> aprob√≥ <strong>${extra.extra_minutes || 0} minutos</strong> adicionales.</p>`;
      html += `</div>`;
      return `<div class="notification-item interface-segunda ${notification.status === 'unread' ? 'unread' : ''}" data-id="${notification.id}">${html}</div>`;
    } 
    else if (notification.type === 'extra_time_rejected') {
      const ownerName = extra.owner_name || 'El arrendador';
      html += `<div class="alert alert-danger mb-0">`;
      html += `<p class="mb-1"><strong>${ownerName}</strong> rechaz√≥ tu solicitud de tiempo extra.</p>`;
      html += `<small class="d-block mb-0">Se aplicar√° multa de <strong>$500 cada 5 min</strong> al exceder tu tiempo.</small>`;
      html += `</div>`;
      return `<div class="notification-item interface-segunda ${notification.status === 'unread' ? 'unread' : ''}" data-id="${notification.id}">${html}</div>`;
    } 
    // ========== FILTRAR NOTIFICACIONES QUE NO SON DEL CONDUCTOR ==========
    else if (notification.type === 'reservation_completed' || notification.type === 'reservation_cancelled') {
      // Mostrar notificaciones de finalizaci√≥n/cancelaci√≥n
      html += `<p>${notification.message}</p>`;
      return `<div class="notification-item ${notification.status === 'unread' ? 'unread' : ''}" data-id="${notification.id}">${html}</div>`;
    }
    else {
      // NO mostrar notificaciones que son del arrendador (driver_arrived, at_vehicle, new_reservation, etc.)
      console.log('Notificaci√≥n filtrada (no es del conductor):', notification.type);
      return ''; // No renderizar nada
    }
  }

  // Funci√≥n para cargar reservas activas y notificaciones
  function loadNotifications() {
  // ========== PRIMERA INTERFAZ: TRAYECTO AL GARAJE ==========
  fetch('/api/reservations/active/driver')
        .then(response => response.json())
        .then(data => {
          let activeHtml = '';
          if (data.success && data.reservations && data.reservations.length > 0) {
            // Solo mostrar reservas pendientes (antes de marcar "Llegu√©")
            const pendingReservations = data.reservations.filter(r => r.status === 'pending');
            activeHtml = pendingReservations.map(r => `
              <div class="notification-item interface-primera active-reservation">
                <div class="interface-header" style="background-color: #FFB300; color: #1A1919;">TRAYECTO AL GARAJE</div>
                <p>Reservaste el garaje <strong>${r.parking_name}</strong> de <strong>${r.owner_name}</strong>.</p>
                <p class="mb-2">Recuerda que tienes que llegar antes de <strong>ETA: <span class="time-remaining" data-duration="${r.eta_minutes||0}" data-occupied="${r.created_at||''}" data-iseta="true" style="display: inline-block; min-width: 65px; text-align: center;">--:--:--</span></strong></p>
                <hr>
                <button class="btn btn-warning me-2" onclick="markAsArrived(${r.id})">Llegu√©</button>
                <button class="btn btn-outline-light" onclick="cancelReservation(${r.id})">Cancelar servicio</button>
              </div>
            `).join('');
          }
          // ========== SEGUNDA INTERFAZ: NOTIFICACIONES DE RESERVA ACTIVA ==========
          fetch('/api/notifications')
            .then(response => response.json())
            .then(data2 => {
              if (data2.success) {
                notifications = data2.notifications;
                updateNotificationCount();
                const notificationsList = document.getElementById('notificationsList');
                if (notificationsList) {
                  let notifHtml = '';
                  if (notifications.length === 0 && !activeHtml) {
                    notifHtml = '<div class="text-center py-4" style="color:#939393;">Buz√≥n vac√≠o</div>';
                  } else {
                    notifHtml = notifications.map(formatNotification).filter(n => n !== '').join('');
                  }
                  notificationsList.innerHTML = activeHtml + notifHtml;
                  // Se√±alamos que el render de notificaciones ha terminado
                  document.dispatchEvent(new Event('notificationsLoaded'));
                  // Si estamos en modo preservar solo botones, aplicarlo inmediatamente para
                  // evitar que la recarga posterior muestre el texto de las notificaciones
                  if (window.preserveNotificationsButtonsOnly) {
                    keepOnlyButtonsInNotifications();
                  }
                }
              }
            })
            .catch(error => console.error('Error cargando notificaciones:', error));
        })
        .catch(error => console.error('Error cargando reservas activas:', error));
  }
  window.loadNotifications = loadNotifications;

  // Mantener solo los botones/controles dentro de cada notificaci√≥n
  function keepOnlyButtonsInNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    if (!notificationsList) return;
    const items = Array.from(notificationsList.querySelectorAll('.notification-item, .active-reservation'));
    if (items.length === 0) return;
    items.forEach(it => {
      // Buscar botones dentro del item
      const buttons = Array.from(it.querySelectorAll('button'));
      if (buttons.length === 0) {
        // Si no hay botones, eliminamos el item
        it.remove();
        return;
      }
      // Construir nuevo contenedor con solamente los botones
      const wrapper = document.createElement('div');
      wrapper.className = 'notification-controls d-flex gap-2';
      buttons.forEach(b => wrapper.appendChild(b));
      // Reemplazar el contenido del item por el wrapper
      it.innerHTML = '';
      it.appendChild(wrapper);
    });
  }

    // Funciones de acci√≥n para las notificaciones
    function markAsArrived(reservationId) {
        fetch(`/api/reservations/${reservationId}/arrived`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNotifications();
            } else {
                alert('Error al marcar llegada: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

  function showGarageInfo(parkingId) {
    // Mostrar informaci√≥n del garaje en un modal o alerta
    fetch(`/api/parkings/${parkingId}`)
      .then(r => r.json())
      .then(data => {
        if (data.id || (data.success && data.parking)) {
          const p = data.parking || data;
          alert(`Garaje: ${p.name}\nDirecci√≥n: ${p.address}\nTel√©fono: ${p.phone}`);
        } else {
          alert('No se pudo obtener la informaci√≥n del garaje');
        }
      })
      .catch(() => alert('Error de red al consultar el garaje'));
  }

  function cancelReservation(reservationId) {
    if (!reservationId) return;
    if (window.pendingCancels && window.pendingCancels.has(reservationId)) return; // evitar duplicados
    if (!confirm('¬øEst√°s seguro de que deseas cancelar la reserva?')) return;
    window.pendingCancels.add(reservationId);
    fetch(`/api/reservations/${reservationId}/cancel`, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Reserva cancelada correctamente');
          loadNotifications();
        } else {
          alert('Error al cancelar la reserva: ' + data.error);
        }
      })
      .catch(() => alert('Error de red al cancelar la reserva'))
      .finally(() => { if (window.pendingCancels) window.pendingCancels.delete(reservationId); });
  }

  function dismissNotification(notificationId) {
    if (!notificationId) return;
    // Eliminar visualmente la notificaci√≥n
    const notifElement = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
    if (notifElement) {
      notifElement.remove();
    }
    // Marcar como le√≠da en el servidor
    fetch('/api/notifications/mark-read', { method: 'POST' })
      .then(() => {
        updateNotificationCount();
        loadNotifications();
      })
      .catch(err => console.error('Error al marcar notificaci√≥n:', err));
  }

    function finishReservation(reservationId) {
        if (confirm('¬øEst√°s seguro de que deseas finalizar la reserva?')) {
            fetch(`/api/reservations/${reservationId}/finish`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotifications();
                } else {
                    alert('Error al finalizar la reserva: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    // Solicitar tiempo extra al arrendador
    function requestExtraTime(reservationId) {
        const minutes = prompt('¬øCu√°ntos minutos adicionales necesitas?\n\n10 - 10 minutos\n20 - 20 minutos\n30 - 30 minutos\n\nIngresa el n√∫mero:', '10');
        if (!minutes || !['10','20','30'].includes(minutes)) {
            if (minutes !== null) alert('Por favor selecciona 10, 20 o 30 minutos.');
            return;
        }
        if (!confirm(`¬øSolicitar ${minutes} minutos adicionales al arrendador?`)) return;
        
        fetch(`/api/reservations/${reservationId}/request-extra-time`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ extra_minutes: parseInt(minutes) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Solicitud enviada al arrendador. Espera su respuesta.');
                loadNotifications();
            } else {
                alert('Error: ' + (data.error || 'No se pudo enviar la solicitud'));
            }
        })
        .catch(() => alert('Error de red al solicitar tiempo extra'));
    }

    // Notificar que lleg√≥ al veh√≠culo
    function notifyAtVehicle(reservationId) {
        if (!confirm('¬øConfirmas que ya est√°s en tu veh√≠culo?')) return;
        
        fetch(`/api/reservations/${reservationId}/at-vehicle`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Se notific√≥ al arrendador que est√°s en tu veh√≠culo.');
                loadNotifications();
            } else {
                alert('Error: ' + (data.error || 'No se pudo notificar'));
            }
        })
        .catch(() => alert('Error de red al notificar llegada'));
    }

    // Funciones del modal
    function openNotificationsModal() {
        const modal = document.getElementById('notificationsModal');
      console.log('openNotificationsModal called, modal:', modal);
        if (modal) {
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            loadNotifications();
            // Marcar todas como le√≠das
            fetch('/api/notifications/mark-read', { method: 'POST' })
                .then(() => loadNotifications())
                .catch(error => console.error('Error marcando notificaciones como le√≠das:', error));
        }
    }

    function closeNotificationsModal() {
        const modal = document.getElementById('notificationsModal');
        if (modal) {
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
        // Desactivar preservaci√≥n cuando se cierra el modal
        window.preserveNotificationsButtonsOnly = false;
        }
    }

  document.addEventListener('DOMContentLoaded', () => {
    console.log('Driver DOMContentLoaded - attaching notification handlers');
    loadNotifications();
    setInterval(loadNotifications, 10000);
    const notificationIcon = document.getElementById('notificationIcon');
    if (notificationIcon) {
      notificationIcon.addEventListener('click', openNotificationsModal);
    }
    const closeModalBtn = document.getElementById('closeModalBtn');
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeNotificationsModal);
    }
  });

  // Actualizar timers dentro del modal (tiempo restante para reservas activas)
  let _notifTimerInterval = null;
  function updateNotificationTimers() {
    // Actualizar todos los spans .time-remaining dentro del listado de notificaciones
    const spans = document.querySelectorAll('#notificationsList .time-remaining');
    spans.forEach(span => {
      const duration = parseInt(span.dataset.duration || '0', 10) || 0; // minutes
      const occupied = span.dataset.occupied || '';
      const isEta = span.dataset.iseta === 'true'; // Si es true, cuenta desde created_at (ETA)
      
      if (!occupied) {
        span.textContent = '--:--:--';
        return;
      }
      const start = Date.parse(occupied);
      if (isNaN(start)) { span.textContent = '--:--:--'; return; }
      const elapsedSec = Math.floor((Date.now() - start) / 1000);
      const remainingSec = Math.max(0, duration * 60 - elapsedSec);
      const hrs = Math.floor(remainingSec / 3600);
      const mins = Math.floor((remainingSec % 3600) / 60);
      const secs = remainingSec % 60;
      span.textContent = String(hrs).padStart(2,'0')+':'+String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
      
      // Si el tiempo se acab√≥, recargar notificaciones para mostrar "No has llegado"
      if (remainingSec === 0 && isEta) {
        setTimeout(() => loadNotifications(), 1000);
      }
    });
  }
  document.addEventListener('notificationsLoaded', () => {
    // limpiar interval existente
    if (_notifTimerInterval) clearInterval(_notifTimerInterval);
    updateNotificationTimers();
    _notifTimerInterval = setInterval(updateNotificationTimers, 1000);
  });
  // Cuando se cierra el modal, detener el timer
  document.getElementById('closeModalBtn') && document.getElementById('closeModalBtn').addEventListener('click', () => { if(_notifTimerInterval){ clearInterval(_notifTimerInterval); _notifTimerInterval = null; } });

  function clearNotificationsMailbox() {
    if (!confirm('¬øEliminar todas las notificaciones no relacionadas con reservas?')) return;
    fetch('/api/notifications/clear', { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
            // Recargar datos y luego limpiar el contenido textual del DOM manteniendo los botones
            loadNotifications();
            // Marcar modo de preservaci√≥n para que futuras recargas no restauren el texto
            window.preserveNotificationsButtonsOnly = true;
            // Ejecutar la limpieza cuando la recarga haya terminado (listener √∫nico)
            const onLoaded = () => {
              keepOnlyButtonsInNotifications();
              alert('Buz√≥n limpiado. Los m√≥dulos interactivos se han preservado.');
            };
            document.addEventListener('notificationsLoaded', onLoaded, { once: true });
        } else {
          alert('Error borrando notificaciones: ' + (d.error || 'desconocido'));
        }
      })
      .catch(() => alert('Error de red al limpiar el buz√≥n'));
  }
  </script>
  {% endraw %}
{% endblock %}